<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>Dasu&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Dasu&#39;s Blog">
<meta property="og:url" content="https://liangjingzhen.github.io/index.html">
<meta property="og:site_name" content="Dasu&#39;s Blog">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Dasu&#39;s Blog">
  
    <link rel="alternate" href="/atom.xml" title="Dasu&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://liangjingzhen.github.io"></form>
      </div>
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">首页</a>
        
          <a class="main-nav-link" href="/archives">归档</a>
        
          <a class="main-nav-link" href="/about">关于</a>
        
      </nav>
      
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Dasu&#39;s Blog</a>
      </h1>
      
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-whatsyourdevice" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/30/whatsyourdevice/" class="article-date">
  <time datetime="2019-11-30T07:57:46.000Z" itemprop="datePublished">2019-11-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/30/whatsyourdevice/">whatsyourdevice</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <p>您的设备标识：</p>
<script type="text/javascript" src="/js/device.js"></script>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://liangjingzhen.github.io/2019/11/30/whatsyourdevice/" data-id="ck3larhy600071wplsw67pjst" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/30/hello-world/" class="article-date">
  <time datetime="2019-11-30T07:31:05.055Z" itemprop="datePublished">2019-11-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/30/hello-world/">Welcome</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <p>Welcome to DASU’s blog!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://liangjingzhen.github.io/2019/11/30/hello-world/" data-id="ck3larhy300061wplw3h4749z" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>
 


  
    <article id="post-JS内部的比较操作算法-SameValue、SameValueZero和SameValueNonNumber" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/24/JS内部的比较操作算法-SameValue、SameValueZero和SameValueNonNumber/" class="article-date">
  <time datetime="2019-08-24T14:58:44.000Z" itemprop="datePublished">2019-08-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/JavaScript语言特性/">JavaScript语言特性</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/24/JS内部的比较操作算法-SameValue、SameValueZero和SameValueNonNumber/">JS内部的相等比较算法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <p>ES标准规范中规定了三种用于比较两个值相等关系的算法：</p>
<ul>
<li>Abstract Equality Comparison (==)</li>
<li>Strict Equality Comparison (===)</li>
<li>SameValue (Object.is)</li>
<li>SameValueZero (Array.prototype.includes/Map.prototype.has/Set.prototype.has)</li>
<li>SameValueNonNumber</li>
</ul>
<ol>
<li>Abstract Equality Comparison</li>
</ol>
<p>抽象相等比较算法，也是大家最熟悉的<code>==</code>运算。如果两个操作数的类型相同，则应用严格相等比较算法，否则，先进行类型转换，再对转换后的值进行比较。</p>
<ol start="2">
<li>Strict Equality Comparison</li>
</ol>
<p>严格相等比较算法，类型不同的两个值不相等。如果两个操作数是数字类型，则直接比较两个数值是否相等；这里需要注意的是，<code>NaN</code>和<code>NaN</code>是不相等的。对于其他类型的操作数，则使用<code>SameValueNonNumber</code>来进行比较。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">NaN</span> === <span class="literal">NaN</span></span><br><span class="line">&gt; <span class="literal">false</span></span><br><span class="line">+<span class="number">0</span> === <span class="number">-0</span></span><br><span class="line">&gt; <span class="literal">true</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>该算法与<code>SameValue</code>的区别在于对正负零和<code>NaN</code>的处理上。</p>
</blockquote>
<ol start="3">
<li>SameValue</li>
</ol>
<p>该算法与严格相等比较算法类似，主要区别在于对正负零和<code>NaN</code>的处理上。<code>SameValue</code>算法中，<code>NaN</code>与<code>NaN</code>是相等的，但<code>+0</code>与<code>-0</code>不相等。<code>Object.is()</code>方法使用了这个算法。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.is(<span class="literal">NaN</span>, <span class="literal">NaN</span>)</span><br><span class="line">&gt; <span class="literal">true</span></span><br><span class="line"><span class="built_in">Object</span>.is(+<span class="number">0</span>, <span class="number">-0</span>)</span><br><span class="line">&gt; <span class="literal">false</span></span><br></pre></td></tr></table></figure></p>
<ol start="4">
<li>SameValueZero</li>
</ol>
<p>类似于<code>SameValue</code>，但该算法将<code>+0</code>与<code>-0</code>视为相等。<code>Array.prototype.includes()/Map.prototype.has()/Set.prototype.has()</code>等方法使用了这个算法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="literal">NaN</span>].includes(<span class="literal">NaN</span>)</span><br><span class="line">&gt; <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[+<span class="number">0</span>].includes(<span class="number">-0</span>)</span><br><span class="line">&gt; <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> s = <span class="keyword">new</span> <span class="built_in">Set</span>()</span><br><span class="line">s.add(<span class="number">0</span>)</span><br><span class="line">s.add(<span class="literal">NaN</span>)</span><br><span class="line">s.has(<span class="number">-0</span>)</span><br><span class="line">&gt; <span class="literal">true</span></span><br><span class="line">s.has(<span class="literal">NaN</span>)</span><br><span class="line">&gt; <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<ol start="5">
<li>SameValueNonNumber</li>
</ol>
<p>在严格比较的情形下，对于任何非数值类型的两个值的比较，均使用此算法。</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ol>
<li><a href="https://www.ecma-international.org/ecma-262/7.0/" target="_blank" rel="noopener">ECMAScript Language Specification</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://liangjingzhen.github.io/2019/08/24/JS内部的比较操作算法-SameValue、SameValueZero和SameValueNonNumber/" data-id="ck3larhxw00021wplcwvnga15" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-ES6以后各版本新特性" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/24/ES6以后各版本新特性/" class="article-date">
  <time datetime="2019-08-24T12:31:31.000Z" itemprop="datePublished">2019-08-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/JavaScript语言特性/">JavaScript语言特性</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/24/ES6以后各版本新特性/">ES6以后各版本新特性</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="ES2016"><a href="#ES2016" class="headerlink" title="ES2016"></a>ES2016</h2><ol>
<li>Exponentiation Operator（幂运算符）</li>
</ol>
<h4 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// x ** y</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> squared = <span class="number">2</span> ** <span class="number">2</span>;</span><br><span class="line"><span class="comment">// 等价于: 2 * 2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> cubed = <span class="number">2</span> ** <span class="number">3</span>;</span><br><span class="line"><span class="comment">// 等价于: 2 * 2 * 2</span></span><br></pre></td></tr></table></figure>
<p>也可以使用赋值运算符形式：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// x **= y</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> a = <span class="number">2</span>;</span><br><span class="line">a **= <span class="number">2</span>;</span><br><span class="line"><span class="comment">// 等价于: a = a * a;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> b = <span class="number">3</span>;</span><br><span class="line">b **= <span class="number">3</span>;</span><br><span class="line"><span class="comment">// 等价于: b = b * b * b;</span></span><br></pre></td></tr></table></figure></p>
<ol start="2">
<li>Array.prototype.include</li>
</ol>
<p>该方法用来判断一个数组中是否包含指定的值，如果包含则返回<code>true</code>，否则返回<code>false</code>。</p>
<h4 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h4><blockquote>
<p>arr.includes(valueToFind[, fromIndex])</p>
</blockquote>
<p>参数说明：</p>
<ul>
<li><code>valueToFind</code> 要搜索的值。对于字符串和字符类型的输入是大小写敏感的。</li>
<li><code>fromIndex</code> 起始搜索位置，可选参数。默认值为0。</li>
</ul>
<blockquote>
<p>从技术上讲，<code>includes()</code>方法使用<a href="../JS内部的比较操作算法-SameValue、SameValueZero和SameValueNonNumber"><code>sameValueZero</code></a>算法来判断数组是否包含给定值。</p>
</blockquote>
<h4 id="用法-1"><a href="#用法-1" class="headerlink" title="用法"></a>用法</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> array1 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(array1.includes(<span class="number">2</span>));</span><br><span class="line"><span class="comment">// &gt; true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> pets = [<span class="string">'cat'</span>, <span class="string">'dog'</span>, <span class="string">'bat'</span>];</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(pets.includes(<span class="string">'cat'</span>));</span><br><span class="line"><span class="comment">// &gt; true</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(pets.includes(<span class="string">'at'</span>));</span><br><span class="line"><span class="comment">// &gt; false</span></span><br></pre></td></tr></table></figure>
<p>与<code>indexOf</code>方法不同的是，<code>includes</code>方法使用的是<code>SameValueZero</code>算法（前者使用的是<code>Strict Equality Comparison</code>算法），因此可以检查数组是否包含<code>NaN</code>，同样也不区分<code>+0</code>和<code>-0</code>。对于稀疏数组，它也不会跳过缺失元素，而是将其作为<code>undefined</code>处理。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="literal">NaN</span>].includes(<span class="literal">NaN</span>)</span><br><span class="line">&gt; <span class="literal">true</span></span><br><span class="line">[<span class="literal">NaN</span>].indexOf(<span class="literal">NaN</span>)</span><br><span class="line">&gt; <span class="number">-1</span></span><br><span class="line"></span><br><span class="line">[<span class="number">-0</span>].includes(+<span class="number">0</span>)</span><br><span class="line">&gt; <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h2 id="ES2017"><a href="#ES2017" class="headerlink" title="ES2017"></a>ES2017</h2><h2 id="ES2018"><a href="#ES2018" class="headerlink" title="ES2018"></a>ES2018</h2><h2 id="ES2019"><a href="#ES2019" class="headerlink" title="ES2019"></a>ES2019</h2><h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ol>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/includes" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/includes</a></li>
<li><a href="https://www.ecma-international.org/ecma-262/7.0/#sec-array.prototype.includes" target="_blank" rel="noopener">https://www.ecma-international.org/ecma-262/7.0/#sec-array.prototype.includes</a></li>
<li><a href="https://github.com/tc39/proposal-exponentiation-operator" target="_blank" rel="noopener">https://github.com/tc39/proposal-exponentiation-operator</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://liangjingzhen.github.io/2019/08/24/ES6以后各版本新特性/" data-id="ck3larhxp00001wpliebn8429" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-深入V8引擎-编写最佳代码的5条建议" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/17/深入V8引擎-编写最佳代码的5条建议/" class="article-date">
  <time datetime="2019-08-17T03:33:54.000Z" itemprop="datePublished">2019-08-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/JavaScript工作原理/">JavaScript工作原理</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/17/深入V8引擎-编写最佳代码的5条建议/">V8引擎及优化代码的5条建议</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>JavaScript引擎（以下简称“JS引擎”）是用来执行JavaScript代码的程序或解释器。<br>JS引擎可以实现为标准解释器，或者是可以将JavaScript代码编译为某种格式的即时（JIT，just-in-time）编译器。</p>
<p>下面列出了一些比较流行的实现了JS引擎的项目：</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/V8_%28JavaScript_engine%29" target="_blank" rel="noopener">V8</a> —— 开源项目，由 Google 开发，C++编写</li>
<li><a href="https://en.wikipedia.org/wiki/Rhino_%28JavaScript_engine%29" target="_blank" rel="noopener">Rhino</a> —— Mozilla 基金会管理的开源项目，完全由 Java 开发</li>
<li><a href="https://en.wikipedia.org/wiki/SpiderMonkey_%28JavaScript_engine%29" target="_blank" rel="noopener">SpiderMonkey</a> —— 第一个JS引擎，以前属于网景浏览器，现在属于Firefox</li>
<li><a href="https://en.wikipedia.org/wiki/JavaScriptCore" target="_blank" rel="noopener">JavaScriptCore</a> —— 开源项目，是苹果公司为 Safari 开发的，对外称作 Nitro</li>
<li><a href="https://en.wikipedia.org/wiki/KJS_%28KDE%29" target="_blank" rel="noopener">KJS</a> —— 最初由 Harri Porten 为  KDE 项目的<code>Konqueror</code>网页浏览器开发的 KDE 引擎</li>
<li><a href="https://en.wikipedia.org/wiki/Chakra_%28JScript_engine%29" target="_blank" rel="noopener">Chakra (JScript9)</a> —— Internet Explorer</li>
<li><a href="https://en.wikipedia.org/wiki/Chakra_%28JavaScript_engine%29" target="_blank" rel="noopener">Chakra (JavaScript)</a> —— Microsoft Edge</li>
<li><a href="https://en.wikipedia.org/wiki/Nashorn_%28JavaScript_engine%29" target="_blank" rel="noopener">Nashorn</a> —— 开源项目，OpenJDK 的一部分，由 Oracle Java语言和工具组（Oracle Java Languages and Tool Group）编写</li>
<li><a href="https://en.wikipedia.org/wiki/JerryScript" target="_blank" rel="noopener">JerryScript</a> —— 用于物联网（Internet of Things）的一款轻量级引擎</li>
</ul>
<h3 id="为什么会有-V8-引擎？"><a href="#为什么会有-V8-引擎？" class="headerlink" title="为什么会有 V8 引擎？"></a>为什么会有 V8 引擎？</h3><p>V8 引擎是 Google 的开源项目，用 C++ 编写。Google Chrome 浏览器内部用的就是该引擎。与其他引擎不同的是，V8 引擎还是 Node.js 运行时的。</p>
<p>V8 最初被设计出来是为了提升 web 浏览器的 JavaScript 代码执行性能。为了提高速度，V8 没有使用解释器，而是像大多数现代 JS 引擎，比如 SpiderMonkey 或者 Rhino（Mozilla）那样，通过实现一种 JIT 编译器，在执行过程中将 JavaScript 代码编译为更高效的机器码。</p>
<h3 id="V8-曾经使用的两个编译器"><a href="#V8-曾经使用的两个编译器" class="headerlink" title="V8 曾经使用的两个编译器"></a>V8 曾经使用的两个编译器</h3><p>在 5.9 版本发布之前，V8 引擎通常使用两个编译器：</p>
<ul>
<li>full-codegen —— 一种简单且非常快速的编译器，可以生成简单但速度相对较慢的机器码</li>
<li>Crankshaft —— 一种更复杂（JIT）的优化编译器，可以生成高度优化的代码</li>
</ul>
<p>V8 引擎内部也使用了多个线程：</p>
<ul>
<li>主线程完成你所期望的任务：获取代码，编译并执行</li>
<li>另一个独立的编译线程，可以确保在优化代码的同时，不影响主线程的运行</li>
<li>一个分析线程，用于通知运行时在哪些方法上面花费了大量时间，以便 Crankshaft 对其进行优化</li>
<li>一些垃圾回收线程</li>
</ul>
<p>当第一次执行 JavaScript 代码时，V8 利用 full-codegen 直接将解析后的代码翻译成机器码，而不进行任何转换。这样就能非常快速地开始执行机器码。需要注意的是，V8 并没有在该过程中使用中间字节码形式，因而也无需使用解释器。</p>
<p>当代码运行一段时间后，分析线程就会收集到足够多的数据来判断哪些代码需要优化。</p>
<p>接下来，在另一个线程中 Crankshaft 开始进行优化。它将 JavaScript 抽象语法树转换为一种称作 Hydrogen 的高级静态单赋值（<a href="https://en.wikipedia.org/wiki/Static_single_assignment_form" target="_blank" rel="noopener">SSA</a>，static single-assignment）表示形式，并尝试优化 Hydrogen 图。大多数优化都是在这级完成的。</p>
<h3 id="内联"><a href="#内联" class="headerlink" title="内联"></a>内联</h3><p>第一个优化就是提前内联尽可能多的代码。内联是将函数调用点（调用函数的代码行）替换为函数体的过程。这一简单步骤使得后续的优化更有意义。</p>
<p><img src="/images/how_javascript_works/v8_fun_call.png" alt></p>
<h3 id="隐藏类"><a href="#隐藏类" class="headerlink" title="隐藏类"></a>隐藏类</h3><p>JavaScript 是基于原型的语言：它没有类；对象通过克隆方式创建。JavaScript 同时也是一门动态语言，意味着你可以很容易给一个对象实例添加或删除属性。</p>
<p>大多数 JavaScript 解释器使用类字典结构（基于哈希函数）来存储对象属性值在内存中的位置。这种结构使得在 JavaScript 中检索一个属性值要比在 Java 或 C# 等非静态语言中带来更多的计算开销。在 Java 中，所有的对象属性在编译前就已经由固定的对象结构确定了，而不能在运行时动态添加或删除（当然了，C# 中也有动态类型，但这是另一个话题了）。因此，这些属性值（或指向这些属性的指针）就能被以彼此相固定的偏移量存储在一段连续的内存当中。偏移长度可以很容易由属性类型确定，而在 JavaScript 中这是不可能的，因为其属性类型可以在运行时被改变。</p>
<p>由于使用字典在内存中查找对象属性非常低效，V8 使用了另外一种方法：<strong>隐藏类</strong>。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://liangjingzhen.github.io/2019/08/17/深入V8引擎-编写最佳代码的5条建议/" data-id="ck3larhyb000b1wpl4deip9ik" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-echarts地图自适应中出现重叠错位的两个地图问题排查" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/27/echarts地图自适应中出现重叠错位的两个地图问题排查/" class="article-date">
  <time datetime="2019-04-27T13:10:41.000Z" itemprop="datePublished">2019-04-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/可视化/">可视化</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/27/echarts地图自适应中出现重叠错位的两个地图问题排查/">echarts地图自适应中出现重叠错位的两个地图问题排查</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <p>项目的可视化模块中使用了<code>echarts</code>作为图表库。当对散点类地图作自适应开发时，发现在对地图进行偏移或缩放的时候，画布上出现了重叠并且错位的两个地图。</p>
<h2 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h2><p><img src="/images/echarts/offset.png" alt="offset"></p>
<p><img src="/images/echarts/zoom.png" alt="zoom"></p>
<p>上图是对地图设置偏移出现的情况，下图是对地图放大出现的情况。为突出对比效果，图中用蓝、黑两种颜色对地图边框进行了着色。</p>
<p>下面分别给出项目中对地图设置偏移和缩放的关键代码，其中的（配置项）主要字段是<code>geo</code>和<code>series</code>：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 偏移</span></span><br><span class="line">option = &#123;</span><br><span class="line">    geo: &#123;</span><br><span class="line">       left: <span class="number">450</span> <span class="comment">// 设置偏移的字段</span></span><br><span class="line">    &#125;,</span><br><span class="line">    series: [</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 放大</span></span><br><span class="line">option = &#123;</span><br><span class="line">    geo: &#123;</span><br><span class="line">        zoom: <span class="number">1.1</span> <span class="comment">// 设置缩放的字段</span></span><br><span class="line">    &#125;,</span><br><span class="line">    series: [</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>正如以上代码所示，根据以往经验，对地图进行偏移或缩放只需在<code>option</code>的<code>geo</code>属性中设置对应字段即可，但显然在当前环境中如此配置并没有达到预期。那么上述现象是由于代码配置项不恰当引起的问题，还是echarts库本身的问题呢？</p>
<h2 id="问题排查"><a href="#问题排查" class="headerlink" title="问题排查"></a>问题排查</h2><p>因为项目中的代码配置项非常多，直接从代码里排查问题比较困难，所以先将其与echarts社区中的示例来作对比，确定是否是echart库的问题。</p>
<p>首先对社区示例代码<a href="https://gallery.echartsjs.com/editor.html?c=xSkUQiHdBz" target="_blank" rel="noopener">点此查看</a>分别进行偏移和缩放设置，发现显示完全正常，并没有出现重叠或错位现象。</p>
<p>既然官方示例没有问题，那是不是自己代码中的<code>option</code>选项哪里设置不对了？当把项目中的<code>option</code>放到示例代码中时，现象出现了，现在可以确定是设置的问题，而不是<code>echarts</code>的问题了。</p>
<p>实际上，项目的代码里已经有人给出了避免对地图画布进行定位时引起地图重影的方法，即同时给<code>geo</code>和<code>series</code>设置相同的偏移量。但是原因是什么呢？看来需要深入<code>echarts</code>项目文档查找答案了。</p>
<p>在<code>echarts</code>的<a href>github</a>项目issues中查找关于地图重叠的问题时，发现了<code>map</code>类型的一个参数：<code>geoIndex</code>，只要将其值设置为<code>0</code>即可。虽然不是最终想要的答案，但却得到了<code>geoIndex</code>这条线索。</p>
<p>打开<code>echarts</code>的配置项手册，查看<code>series-map</code>的<code>geoIndex</code>选项，发现如下描述：</p>
<blockquote>
<p>默认情况下，map series 会自己生成内部专用的<code>geo</code>组件。但是也可以用这个<code>geoIndex</code>指定一个<code>geo</code>组件。<br>…<br>当设定了<code>geoIndex</code>后，series-map.map 属性，以及 series-map.itemStyle 等样式配置不再起作用，而是采用<code>geo</code>中的相应属性。</p>
</blockquote>
<p>原来<code>geo</code>和<code>series-map</code>是两个相互独立的组件，所以最初代码只对<code>geo</code>进行偏移或缩放设置时，会出现重叠的地图。因此当二者同时使用时，要么（一）同时设置缩放或者偏移量，要么（二）给<code>series-map.map</code>指定关联的<code>geo</code>组件，才能让画布上的地图正常显示。考虑到项目允许对可视化组件进行自定义配置，所以最后采用了第一种方案。</p>
<p>修改后的代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">option = &#123;</span><br><span class="line">    geo: &#123;</span><br><span class="line">        zoom: <span class="number">1.1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    series: [</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        &#123;</span><br><span class="line">            zoom: <span class="number">1.1</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/echarts/normal.png" alt="正常缩放的地图"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>成熟的工具库或者框架可以极大地方便项目开发，但是使用过程中难免会遇到各种各样的问题，导致开发中断甚至延误项目进度。回过头来看排查过程，这个问题还是由于对使用文档不熟悉，不了解API的使用造成的。所以使用三方库之前一定要理解其原理，并熟练掌握各种API，而且一定要仔细读官方文档，因为很多问题的答案都在其中。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://liangjingzhen.github.io/2019/04/27/echarts地图自适应中出现重叠错位的两个地图问题排查/" data-id="ck3larhy100051wpl9dmak5i6" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/echarts/">echarts</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-网站用户访问量统计-用户标识" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/27/网站用户访问量统计-用户标识/" class="article-date">
  <time datetime="2019-04-27T09:47:11.000Z" itemprop="datePublished">2019-04-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/APM/">APM</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/27/网站用户访问量统计-用户标识/">网站用户访问量统计-用户标识</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <p>一个站点的访问用户，从业务角度看，可分为登录用户和访客用户。登录用户有明确的标识符（比如user_id），而访客用户则需要通过其它指标来标识。<br>因此，要统计访问用户量，需要解决以下几点：</p>
<ol>
<li>针对登录用户，用户标识是什么？</li>
<li>针对登录用户，从哪种渠道获取用户标识，cookie中、jsp变量中、还是js变量中？还是其它？</li>
<li>针对访客用户，使用哪种方式来标识用户？</li>
</ol>
<h2 id="几种常用工具的对比"><a href="#几种常用工具的对比" class="headerlink" title="几种常用工具的对比"></a>几种常用工具的对比</h2><p>下面对几种经常使用的统计工具GrowingIO（GR）、Google Analytics（GA）、百度统计的配置方法和数据发送方式逐个进行分析。</p>
<h3 id="SDK配置和用户信息采集"><a href="#SDK配置和用户信息采集" class="headerlink" title="SDK配置和用户信息采集"></a>SDK配置和用户信息采集</h3><p>三种工具均基于cookie来采集数据：当页面加载SDK时，服务器向客户端写入标识用户身份的cookie，百度统计还设置了会话cookie（session）。</p>
<p><img src="/images/网站用户访问量的统计方法/figure1.png" alt></p>
<center>图1：GR、GA、百度统计在客户端设置的用于标识用户ID的cookie</center>

<h4 id="GrowingIO"><a href="#GrowingIO" class="headerlink" title="GrowingIO"></a>GrowingIO</h4><p>1.系统分配项目ID<br>2.将生成的跟踪ID配置到SDK（一段内联js脚本）中<br>3.在加载SDK的内联代码中设置关注字段，示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_vds.push([&apos;setCS1&apos;, &apos;CS1的key&apos;, &apos;CS1的value&apos;]);</span><br><span class="line">_vds.push([&apos;setCS2&apos;, &apos;CS2的key&apos;, &apos;CS2的value&apos;]);</span><br></pre></td></tr></table></figure></p>
<p>其中CS1用于识别用户身份ID，即客户应用中的登录用户。</p>
<ol start="4">
<li>客户应用加载SDK后，向客户端写入cookie（含会话cookie）</li>
<li>从cookie中获取用户ID，作为参数发送给服务器</li>
</ol>
<p>GR用户可任意时候登录系统设置用户群，设置后GR将自动关联用户信息。</p>
<h4 id="Google-Analytics"><a href="#Google-Analytics" class="headerlink" title="Google Analytics"></a>Google Analytics</h4><ol>
<li>设置统计名称，登记监控网站地址，设置其它辅助信息</li>
<li>分配跟踪ID    </li>
<li><p>将生成的跟踪ID配置到SDK（一段内联js脚本）中。如果要启用“会话统一”，即归集登录用户数据，则需在SDK中添加下面的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ga(&apos;set&apos;, &apos;userId&apos;, &#123;&#123;USER_ID&#125;&#125;); // 使用已登录的 user_id 来设置 User ID。</span><br></pre></td></tr></table></figure>
</li>
<li><p>客户应用加载SDK后，向客户端写入cookie（含会话cookie）</p>
</li>
<li>从cookie中获取用户ID，作为参数发送给服务器</li>
</ol>
<h4 id="百度统计"><a href="#百度统计" class="headerlink" title="百度统计"></a>百度统计</h4><ol>
<li>由“账户+站点”生成跟踪ID    </li>
<li>将生成的跟踪ID配置到SDK（一段内联js脚本）中。</li>
<li><p>在加载SDK的内联代码中设置关注字段，示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_. mt.push([&apos;_setCustomVar&apos;, index, name, value, opt_scope]);</span><br></pre></td></tr></table></figure>
</li>
<li><p>客户应用加载SDK后，向客户端写入cookie（含会话cookie）</p>
</li>
<li>携带cookie提交请求至服务器</li>
</ol>
<h3 id="数据上传"><a href="#数据上传" class="headerlink" title="数据上传"></a>数据上传</h3><p>GrowingIO是通过XMLHttpRequest（XHR）方式上传数据的，而百度统计和GA则是通过向服务器发送一个图片请求（图像灯标）来上传数据的。</p>
<p>XMLHttpRequest（XHR）用来异步收发数据，可以向请求报文中添加任意的头信息和参数（包括GET和POST），并读取从服务器返回的头信息，以及响应文本自身。    但XHR发送数据受到跨域的影响。</p>
<p>图像灯标方式通过向服务器请求一个透明的1×1的GIF图片文件，这个文件请求以及请求时间会在服务器日志中被记录，而文件请求信息包含了统计代码收集的数据和Cookie信息。这是将信息发回服务器的最有效方法。其开销很小，而且任何服务器端错误都不会影响客户端。但是该方式有个缺点，只能发送数量有限的数据。</p>
<h3 id="特性概括"><a href="#特性概括" class="headerlink" title="特性概括"></a>特性概括</h3><p>以上三种统计的共同点是，web应用开发者都是通过在需要监控的页面增加一段内联脚本从服务提供商的服务器下载文件，即所谓的“异步加载执行”。</p>
<p>“用户标识”都是由使用方（客户）来定义的，三者都提供了JS API，可用于设置登录用户标识（参数的格式由服务商指定，设置工作需要由使用方开发者来完成）。如果没有设置登录用户标识，则随机生成一个字符串，作为访客标记。Cookie中的标记始终被上传到服务器。</p>
<h2 id="用户标识方案"><a href="#用户标识方案" class="headerlink" title="用户标识方案"></a>用户标识方案</h2><p>参考已有统计工具，这里提出如下实现方案：</p>
<h3 id="用户判定规则"><a href="#用户判定规则" class="headerlink" title="用户判定规则"></a>用户判定规则</h3><p>将每个客户端视为一个用户，在cookie中设置用户ID。如果已设置了登录用户标识，则以设置值为准，否则使用随机生成的字符串作为用户ID。</p>
<p>Cookie需设置足够长的有效期，比如10年。当用户清除本地cookie时，需要重新生成cookie，这将会认为是一个新用户。</p>
<h3 id="JS-API"><a href="#JS-API" class="headerlink" title="JS-API"></a>JS-API</h3><p>声明全局变量（也可使用命名空间以减少全局污染）<code>userid</code>，其值可为指定的用户ID值（常量），也可定义为一个函数，但需要有返回值，该值将作为用户ID。如果为jsp页面，可用<code>&lt;%=USER_ID %&gt;</code>这类变量来动态获取。</p>
<pre><code>// declare variable
userid = value;

// 将`userid`保存至全域cookie中（如果已经存在则跳过）
(userid = getCookie(&quot;_user_id&quot;)) 
|| (userid = typeof value === &quot;string&quot; 
    ? value 
    : typeof value === &quot;function&quot; 
        ? value() 
        : randomString();

setCookie(&quot;_user_id&quot;, userid, domain, &quot;/&quot;, expires);

// 向服务器发送前从cookie中取出用户ID，设置为参数
function assembleData() {
    // ...
    userid = getCookie(&quot;_user_id&quot;);
    setRequestParam(&quot;userid&quot;, userid);
    // ...
}

// 发送到服务器
send();
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://liangjingzhen.github.io/2019/04/27/网站用户访问量统计-用户标识/" data-id="ck3larhyd000c1wplo1cohrha" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web监控/">Web监控</a></li></ul>

    </footer>
  </div>
  
</article>
 


  

</section>
           
    <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title categories">分类</h3>
    <div class="widget" id="categories">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/APM/">APM</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript工作原理/">JavaScript工作原理</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript语言特性/">JavaScript语言特性</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/可视化/">可视化</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title tagcloud">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/JavaScript/" style="font-size: 25px;">JavaScript</a> <a href="/tags/Web监控/" style="font-size: 14px;">Web监控</a> <a href="/tags/echarts/" style="font-size: 14px;">echarts</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title recent-posts">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/11/30/whatsyourdevice/">whatsyourdevice</a>
          </li>
        
          <li>
            <a href="/2019/11/30/hello-world/">Welcome</a>
          </li>
        
          <li>
            <a href="/2019/08/24/JS内部的比较操作算法-SameValue、SameValueZero和SameValueNonNumber/">JS内部的相等比较算法</a>
          </li>
        
          <li>
            <a href="/2019/08/24/ES6以后各版本新特性/">ES6以后各版本新特性</a>
          </li>
        
          <li>
            <a href="/2019/08/17/深入V8引擎-编写最佳代码的5条建议/">V8引擎及优化代码的5条建议</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title archive">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>


  
</aside>

      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-left">
      &copy; 2014 - 2019 Dasu&nbsp;|&nbsp;
      主题 <a href="https://github.com/giscafer/hexo-theme-cafe/" target="_blank">Cafe</a>
    </div>
     <div id="footer-right">
      联系方式&nbsp;|&nbsp;xiaolgoon@gmail.com
    </div>
  </div>
</footer>
 <script src="/jquery/jquery.min.js"></script>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
    <a href="/about" class="mobile-nav-link">关于</a>
  
</nav>
    <img class="back-to-top-btn" src="/images/fly-to-top.png">
<script>
// Elevator script included on the page, already.
window.onload = function() {
  var elevator = new Elevator({
    selector:'.back-to-top-btn',
    element: document.querySelector('.back-to-top-btn'),
    duration: 1000 // milliseconds
  });
}
</script>
    
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      })
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      })
    </script>
    <script type="text/javascript" src="https://cdn.rawgit.com/mathjax/MathJax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


 <script src="/js/is.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/elevator.js"></script>
  </div>
</body>
</html>